<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Utama</title>
    <link rel="icon" type="image/png" href="logo.png" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        background: #f1f8f4;
      }
      .admin-dashboard {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 250px;
        background: linear-gradient(180deg, #2e7d32 80%, #388e3c 100%);
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        box-shadow: 2px 0 12px #0001;
        z-index: 10;
        min-height: 100vh;
        height: 100vh;
      }
      .sidebar-logo {
        font-size: 1.7rem;
        font-weight: bold;
        padding: 32px 0 24px 0;
        text-align: center;
        letter-spacing: 1px;
        border-bottom: 1px solid #388e3c44;
      }
      .sidebar-nav {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 24px;
        padding: 0 18px;
        flex: 1;
      }
      .nav-btn {
        background: none;
        border: none;
        color: #fff;
        font-size: 1.08rem;
        font-weight: 500;
        text-align: left;
        padding: 12px 18px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 14px;
        transition: background 0.18s, color 0.18s;
      }
      .nav-btn:hover,
      .nav-btn.active {
        background: #e8f5e9;
        color: #2e7d32;
      }
      .main-content {
        margin-left: 250px;
        flex: 1;
        padding: 36px 36px 36px 36px;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 32px;
      }
      .main-header {
        margin-bottom: 18px;
        border-bottom: 1px solid #c8e6c9;
        padding-bottom: 12px;
      }
      .main-header h1 {
        color: #2e7d32;
        font-size: 2rem;
        margin: 0;
        font-weight: 700;
        letter-spacing: 1px;
      }
      .dashboard-actions-top {
        display: flex;
        gap: 12px;
        margin-bottom: 18px;
      }
      .btn.btn-outline {
        background: #fff;
        color: #388e3c;
        border: 1.5px solid #388e3c;
        border-radius: 6px;
        padding: 7px 14px;
        font-size: 0.98rem;
        font-weight: 500;
        transition: background 0.18s, color 0.18s, border 0.18s;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .btn.btn-outline:hover {
        background: #e8f5e9;
        color: #2e7d32;
        border-color: #2e7d32;
      }
      .btn.btn-outline.danger {
        color: #b71c1c;
        border-color: #b71c1c;
      }
      .btn.btn-outline.danger:hover {
        background: #ffebee;
        color: #b71c1c;
        border-color: #b71c1c;
      }
      .dashboard-section {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 16px #0001;
        padding: 28px 24px 24px 24px;
        margin-bottom: 18px;
      }
      .dashboard-section h2 {
        color: #388e3c;
        font-size: 1.3rem;
        margin-bottom: 18px;
        font-weight: 600;
      }
      .loket-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        padding: 20px 0;
      }
      .loket-box {
        position: relative;
        background: white;
        border-radius: 10px;
        width: 300px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border-left: 6px solid #4caf50;
      }
      .loket-status-dot {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #f44336;
        box-shadow: 0 0 8px #f4433644;
        border: 2px solid #fff;
        display: none;
      }
      .loket-box.nonaktif .loket-status-dot {
        display: block;
      }
      .loket-title {
        background-color: #e8f5e9;
        color: #2e7d32;
        padding: 14px;
        font-size: 1.1rem;
        font-weight: bold;
        text-align: center;
      }
      .btn {
        padding: 6px 10px;
        font-size: 0.9rem;
        font-weight: bold;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 0 2px;
      }
      .btn-panggil {
        background-color: #4caf50;
        color: white;
      }
      .btn-hapus {
        background-color: #f44336;
        color: white;
      }
      .btn-aktif {
        background-color: #43a047;
        color: #fff;
        margin-right: 6px;
        border: none;
        border-radius: 4px;
        padding: 6px 14px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
      }
      .btn-aktif:hover:enabled {
        background-color: #388e3c;
      }
      .btn-nonaktif {
        background-color: #f44336;
        color: #fff;
        border: none;
        border-radius: 4px;
        padding: 6px 14px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
      }
      .btn-nonaktif:hover:enabled {
        background-color: #b71c1c;
      }
      .btn-aktif:disabled,
      .btn-nonaktif:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .kosong {
        text-align: center;
        padding: 14px;
        font-style: italic;
        color: #888;
      }
      /* Modal Rekap */
      #rekapModal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: #0008;
        align-items: center;
        justify-content: center;
      }
      #rekapModal.show {
        display: flex;
      }
      .rekap-modal-content {
        background: #fff;
        padding: 24px 18px;
        max-width: 95vw;
        width: 420px;
        border-radius: 12px;
        box-shadow: 0 4px 24px #0002;
        position: relative;
      }
      .close-rekap {
        position: absolute;
        top: 8px;
        right: 12px;
        font-size: 1.3rem;
        background: none;
        border: none;
        cursor: pointer;
      }
      .rekap-filter {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 18px;
        align-items: center;
        margin-bottom: 18px;
      }
      .rekap-filter label {
        font-weight: 500;
        color: #2e7d32;
      }
      .rekap-filter select,
      .rekap-filter input[type="date"],
      .rekap-filter input[type="month"] {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #c8e6c9;
        font-size: 1rem;
      }
      .rekap-filter button {
        padding: 7px 14px;
        border-radius: 6px;
        border: none;
        font-weight: bold;
        background: #43a047;
        color: #fff;
        cursor: pointer;
        transition: background 0.18s;
      }
      .rekap-filter button:hover {
        background: #388e3c;
      }
      .rekap-filter .danger {
        background: #b71c1c;
      }
      .rekap-filter .danger:hover {
        background: #f44336;
      }
      .rekap-tabel {
        margin-top: 10px;
        max-height: 40vh;
        overflow: auto;
        font-size: 0.98rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 10px;
        text-align: center;
        font-size: 0.95rem;
      }
      th {
        background-color: #c8e6c9;
      }
      tr:nth-child(even) {
        background-color: #f1f8e9;
      }
      .belum-dipanggil {
        background-color: #eb8c8c !important; /* kuning muda, menandakan baru masuk */
        font-weight: bold;
        box-shadow: 0 0 8px #e5393533;
        color: #3b1010;
        animation: pulseBaru 1.1s infinite alternate;
      }
      @keyframes pulseBaru {
        from {
          box-shadow: 0 0 8px #e5393533;
        }
        to {
          box-shadow: 0 0 16px #e5393599;
        }
      }
      .sudah-dipanggil {
        background-color: #e8f5e9 !important; /* hijau muda, sudah dipanggil */
        color: #388e3c;
      }
      @media (max-width: 900px) {
        .admin-dashboard {
          flex-direction: column;
        }
        .sidebar {
          width: 100vw;
          flex-direction: row;
          height: 60px;
          position: static;
          box-shadow: none;
          border-bottom: 1px solid #388e3c44;
          min-height: unset;
        }
        .sidebar-logo {
          display: none;
        }
        .sidebar-nav {
          flex-direction: row;
          gap: 0;
          margin: 0;
          padding: 0 4px;
          width: 100vw;
          justify-content: space-around;
        }
        .nav-btn {
          flex: 1 1 0;
          padding: 10px 2px;
          font-size: 0.98rem;
          border-radius: 0;
          min-width: 0;
          justify-content: center;
        }
        .main-content {
          padding: 18px 4vw 18px 4vw;
        }
        .loket-container {
          gap: 12px;
          padding: 0;
        }
        .loket-box {
          width: 98vw;
          min-width: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-dashboard">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-logo">
          <span>Admin Panel</span>
        </div>
        <nav class="sidebar-nav">
          <button class="nav-btn active" id="navDashboard">
            <i class="bi bi-speedometer2"></i> Dashboard
          </button>
          <button class="nav-btn" id="navDisplay">
            <i class="bi bi-tv"></i> Kelola Display
          </button>
          <button class="nav-btn" id="navIndex">
            <i class="bi bi-house-door"></i> Kelola Index
          </button>
          <button class="nav-btn" id="navAkun">
            <i class="bi bi-person-gear"></i> Kelola Akun
          </button>
          <button class="nav-btn" id="navRekap">
            <i class="bi bi-clipboard-data"></i> Rekap Antrian
          </button>
          <button class="nav-btn" id="btnLogout">
            <i class="bi bi-box-arrow-right"></i> Logout
          </button>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <header class="main-header">
          <h1>Selamat Datang, Admin Utama</h1>
        </header>
        <div
          style="
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 10px;
          "
        >
          <span
            id="namaProfilAdmin"
            style="font-size: 1.1rem; color: #388e3c; font-weight: 600"
          ></span>
        </div>
        <div class="dashboard-actions-top">
          <button id="btnHapusSemua" class="btn btn-outline danger">
            <i class="bi bi-trash3"></i> Hapus Semua Antrian
          </button>
        </div>
        <section class="dashboard-section" id="dashboardSection">
          <h2><i class="bi bi-speedometer2"></i> Dashboard</h2>
          <div class="loket-container" id="containerLoket"></div>
        </section>
      </main>
    </div>

    <!-- Modal Rekap -->

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
      import {
        getAuth,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        set,
        remove,
        onValue,
        get,
      } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

      import { db } from "./js/firebase-config.js"; // Ganti path sesuai lokasi file

      const loketList = ["H", "G", "E", "F", "D"];
      const namaLoket = {
        H: "POJOK E-COURT",
        G: "PELAYANAN INFORMASI",
        E: "KASIR",
        F: "PENGAMBILAN PRODUK",
        D: "POSBAKUM",
      };

      const todayStr = new Date().toISOString().slice(0, 10);
      const lastReset = localStorage.getItem("lastResetAntrian");

      if (lastReset !== todayStr) {
        (async () => {
          for (let loket of loketList) {
            await remove(ref(db, `antrian/loket${loket}`));
            await set(ref(db, `display/aktif/${loket}`), "-");
          }
          await set(ref(db, "display/terkini"), { nomor: "-", waktu: "" });
          localStorage.setItem("lastResetAntrian", todayStr);
          // Optional: alert("Antrian direset otomatis hari ini.");
        })();
      }

      const container = document.getElementById("containerLoket");
      const listeners = {};

      function buatStrukturTabel(loket) {
        const box = document.createElement("div");
        box.className = "loket-box";
        // Tambahkan status dot
        const statusDot = document.createElement("div");
        statusDot.className = "loket-status-dot";
        box.appendChild(statusDot);

        const title = document.createElement("div");
        title.className = "loket-title";
        title.textContent = `Loket ${loket} - ${namaLoket[loket]}`;
        box.appendChild(title);

        const statusDiv = document.createElement("div");
        statusDiv.style.textAlign = "center";
        statusDiv.style.margin = "8px 0";

        // Cek status aktif/nonaktif dari Firebase
        onValue(ref(db, `status_loket/${loket}`), (snap) => {
          const aktif = snap.val() !== false;
          if (!aktif) {
            box.classList.add("nonaktif");
          } else {
            box.classList.remove("nonaktif");
          }
          // Disable semua tombol aksi di box ini
          box
            .querySelectorAll(
              "button.btn, button.btn-panggil, button.btn-hapus"
            )
            .forEach((btn) => {
              btn.disabled = !aktif;
            });
          // Tombol aktif/nonaktif tetap bisa ditekan
          btnAktif.disabled = aktif;
          btnNonaktif.disabled = !aktif;
        });

        // Tombol aktif/nonaktif
        const btnAktif = document.createElement("button");
        btnAktif.textContent = "Aktifkan";
        btnAktif.className = "btn-aktif";
        btnAktif.onclick = () => set(ref(db, `status_loket/${loket}`), true);

        const btnNonaktif = document.createElement("button");
        btnNonaktif.textContent = "Nonaktifkan";
        btnNonaktif.className = "btn-nonaktif";
        btnNonaktif.onclick = () =>
          set(ref(db, `status_loket/${loket}`), false);

        statusDiv.appendChild(btnAktif);
        statusDiv.appendChild(btnNonaktif);
        box.appendChild(statusDiv);

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = `<tr><th>No</th><th>Aksi</th></tr>`;
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        tbody.id = `tbody-${loket}`;
        table.appendChild(tbody);

        box.appendChild(table);
        container.appendChild(box);

        setupListenerLoket(loket);
      }

      function setupAllTabel() {
        container.innerHTML = "";
        for (let loket of loketList) {
          buatStrukturTabel(loket);
        }
      }

      function setupListenerLoket(loket) {
        const tbody = document.getElementById(`tbody-${loket}`);
        const dbRef = ref(db, `antrian/loket${loket}`);
        if (listeners[loket]) return;

        listeners[loket] = onValue(dbRef, (snapshot) => {
          const data = snapshot.val() || {};
          const nomorList = Object.keys(data)
            .map((key) => ({ nomor: key, ...data[key] }))
            .sort((a, b) => new Date(b.waktu) - new Date(a.waktu));

          tbody.innerHTML = "";

          if (nomorList.length === 0) {
            tbody.innerHTML = `<tr><td colspan="2" class="kosong">Belum ada antrian.</td></tr>`;
            return;
          }

          nomorList.forEach((item) => {
            const tr = document.createElement("tr");
            tr.dataset.nomor = item.nomor;

            // Warna latar sesuai status
            if (item.status === "dipanggil") {
              tr.classList.add("sudah-dipanggil");
              tr.style.backgroundColor = "#c8e6c9"; // hijau terang
              tr.style.color = "#388e3c";
            } else {
              tr.classList.add("belum-dipanggil");
              tr.style.backgroundColor = "#fffff "; // merah terang
              tr.style.color = "#fffff ";
            }

            const tdNomor = document.createElement("td");
            tdNomor.textContent = item.nomor;

            const tdAksi = document.createElement("td");

            const btnPanggil = document.createElement("button");
            btnPanggil.className = "btn btn-panggil";
            btnPanggil.textContent =
              item.status === "dipanggil" ? "Panggil Ulang" : "Panggil";
            btnPanggil.onclick = async () => {
              await set(ref(db, "display/terkini"), {
                nomor: item.nomor,
                waktu: new Date().toISOString(),
              });
              await set(ref(db, `display/aktif/${loket}`), item.nomor);
              await set(ref(db, `antrian/loket${loket}/${item.nomor}`), {
                ...item,
                status: "dipanggil",
              });
            };

            if (item.status === "dipanggil") {
              tdAksi.appendChild(btnPanggil);
              const info = document.createElement("span");
              info.textContent = "Sudah Dipanggil";
              info.style.color = "#388e3c";
              info.style.fontWeight = "bold";
              info.style.marginLeft = "10px";
              tdAksi.appendChild(info);
            } else {
              tdAksi.appendChild(btnPanggil);
              // Tidak ada tombol hapus untuk yang belum dipanggil
            }

            tr.appendChild(tdNomor);
            tr.appendChild(tdAksi);
            tbody.appendChild(tr);
          });
        });
      }

      window.logout = function () {
        signOut(auth)
          .then(() => {
            window.location.href = "login.html";
          })
          .catch((error) => {
            alert("Gagal logout: " + error.message);
          });
      };

      // Sidebar Navigation
      document.getElementById("navDashboard").onclick = function () {
        window.location.href = "admin.html";
      };
      document.getElementById("navDisplay").onclick = function () {
        window.location.href = "admin-display.html";
      };
      document.getElementById("navIndex").onclick = function () {
        window.location.href = "admin-index.html";
      };
      document.getElementById("navAkun").onclick = function () {
        window.location.href = "admin-akun.html";
      };
      document.getElementById("navRekap").onclick = function () {
        window.location.href = "rekap.html";
      };
      document.getElementById("btnLogout").onclick = function () {
        localStorage.clear();
        window.location.href = "login.html";
      };

      // Cek login dan role
      const uid = localStorage.getItem("uid");
      const role = localStorage.getItem("role");
      if (!uid || role !== "utama") {
        window.location.href = "login.html";
      }

      setupAllTabel();

      document.getElementById("btnHapusSemua").onclick = async () => {
        if (
          !confirm(
            "Yakin ingin menghapus SEMUA antrian di SEMUA loket? Tindakan ini tidak bisa dibatalkan!"
          )
        )
          return;
        try {
          for (let loket of loketList) {
            await remove(ref(db, `antrian/loket${loket}`));
            await set(ref(db, `display/aktif/${loket}`), "-");
          }
          await set(ref(db, "display/terkini"), { nomor: "-", waktu: "" });
          alert("Semua antrian berhasil dihapus.");
          setupAllTabel();
        } catch (e) {
          alert("Gagal menghapus semua antrian: " + e.message);
        }
      };
    </script>
  </body>
</html>
