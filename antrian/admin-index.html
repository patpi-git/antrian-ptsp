<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Mesin Antrian</title>
    <link rel="icon" type="image/png" href="logo.png" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        background: #f1f8f4;
      }
      .admin-dashboard {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 250px;
        background: linear-gradient(180deg, #2e7d32 80%, #388e3c 100%);
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        box-shadow: 2px 0 12px #0001;
        z-index: 10;
        min-height: 100vh;
        height: 100vh;
      }
      .sidebar-logo {
        font-size: 1.7rem;
        font-weight: bold;
        padding: 32px 0 24px 0;
        text-align: center;
        letter-spacing: 1px;
        border-bottom: 1px solid #388e3c44;
      }
      .sidebar-nav {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 24px;
        padding: 0 18px;
        flex: 1;
      }
      .nav-btn {
        background: none;
        border: none;
        color: #fff;
        font-size: 1.08rem;
        font-weight: 500;
        text-align: left;
        padding: 12px 18px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 14px;
        transition: background 0.18s, color 0.18s;
      }
      .nav-btn:hover,
      .nav-btn.active {
        background: #e8f5e9;
        color: #2e7d32;
      }
      .main-content {
        margin-left: 250px;
        flex: 1;
        padding: 36px 36px 36px 36px;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 32px;
      }
      .main-header {
        margin-bottom: 18px;
        border-bottom: 1px solid #c8e6c9;
        padding-bottom: 12px;
      }
      .main-header h1 {
        color: #2e7d32;
        font-size: 2rem;
        margin: 0;
        font-weight: 700;
        letter-spacing: 1px;
      }
      .dashboard-section {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 16px #0001;
        padding: 28px 24px 24px 24px;
        margin-bottom: 18px;
        max-width: 700px;
      }
      .dashboard-section h2 {
        color: #388e3c;
        font-size: 1.3rem;
        margin-bottom: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      label {
        font-weight: 500;
        color: #388e3c;
        display: block;
        margin-bottom: 6px;
      }
      textarea,
      input[type="text"],
      input[type="color"],
      select {
        width: 100%;
        font-size: 1.1rem;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #c8e6c9;
        margin-bottom: 10px;
        background: #f8fffa;
        color: #222;
        box-sizing: border-box;
      }
      .btn {
        background: #43a047;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 18px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.18s;
        margin-right: 6px;
        outline: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .btn:hover,
      .btn:focus {
        background: #388e3c;
      }
      .btn-reset {
        background: #f44336;
        color: #fff;
      }
      .btn-reset:hover,
      .btn-reset:focus {
        background: #b71c1c;
        color: #fff;
      }
      .status,
      #status,
      #bgStatus {
        margin-top: 8px;
        color: #388e3c;
        font-size: 0.98rem;
        min-height: 20px;
      }
      .setting-group {
        margin-bottom: 24px;
      }
      .setting-row {
        display: flex;
        gap: 16px;
        align-items: center;
        margin-bottom: 10px;
      }
      .setting-row label {
        min-width: 120px;
        margin-bottom: 0;
      }
      @media (max-width: 900px) {
        .admin-dashboard {
          flex-direction: column;
        }
        .sidebar {
          width: 100vw;
          flex-direction: row;
          height: 60px;
          position: static;
          box-shadow: none;
          border-bottom: 1px solid #388e3c44;
          min-height: unset;
        }
        .sidebar-logo {
          display: none;
        }
        .sidebar-nav {
          flex-direction: row;
          gap: 0;
          margin: 0;
          padding: 0 4px;
          width: 100vw;
          justify-content: space-around;
        }
        .nav-btn {
          flex: 1 1 0;
          padding: 10px 2px;
          font-size: 0.98rem;
          border-radius: 0;
          min-width: 0;
          justify-content: center;
        }
        .main-content {
          padding: 18px 4vw 18px 4vw;
        }
        .dashboard-section {
          padding: 14px 4vw 14px 4vw;
          margin-bottom: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-dashboard">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-logo">
          <span>Admin Panel</span>
        </div>
        <nav class="sidebar-nav">
          <button class="nav-btn" id="navDashboard">
            <i class="bi bi-speedometer2"></i> Dashboard
          </button>
          <button class="nav-btn" id="navDisplay">
            <i class="bi bi-tv"></i> Kelola Display
          </button>
          <button class="nav-btn active" id="navIndex">
            <i class="bi bi-house-door"></i> Kelola Index
          </button>
          <button class="nav-btn" id="navAkun">
            <i class="bi bi-person-gear"></i> Kelola Akun
          </button>
          <button class="nav-btn" id="navRekap">
            <i class="bi bi-clipboard-data"></i> Rekap Antrian
          </button>
          <button class="nav-btn" id="btnLogout">
            <i class="bi bi-box-arrow-right"></i> Logout
          </button>
        </nav>
      </aside>
      <main class="main-content">
        <div class="main-header">
          <h1>Pengaturan Marquee</h1>
        </div>
        <div class="dashboard-section">
          <h2>Pengaturan Marquee</h2>
          <div class="setting-group">
            <label for="marqueeInput">Teks Marquee:</label>
            <textarea id="marqueeInput" rows="3" cols="60"></textarea>
          </div>
          <button id="saveMarquee" class="btn">
            <i class="bi bi-save"></i> Simpan
          </button>
          <div id="status" class="status"></div>
        </div>

        <div class="dashboard-section">
          <h2><i class="bi bi-clock-history"></i> Riwayat Marquee</h2>
          <div style="overflow-x: auto">
            <table style="width: 100%; border-collapse: collapse">
              <thead>
                <tr style="background: #e8f5e9">
                  <th style="padding: 8px 6px; text-align: left">Teks</th>
                  <th style="padding: 8px 6px; text-align: left">Waktu</th>
                  <th style="padding: 8px 6px; text-align: left">Aksi</th>
                </tr>
              </thead>
              <tbody id="marqueeHistoryBody">
                <tr>
                  <td colspan="3" style="text-align: center; color: #888">
                    Memuat...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <script type="module">
          import { db } from "./js/firebase-config.js";
          import {
            ref,
            set,
            get,
            onValue,
            push,
            remove,
          } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

          const marqueeInput = document.getElementById("marqueeInput");
          const statusDiv = document.getElementById("status");

          // Load marquee awal
          get(ref(db, "pengaturan/marquee")).then((snap) => {
            if (snap.exists()) marqueeInput.value = snap.val();
          });

          // Simpan ke riwayat saat marquee disimpan
          document.getElementById("saveMarquee").onclick = async function () {
            await set(ref(db, "pengaturan/marquee"), marqueeInput.value);
            // Simpan ke riwayat
            const newRef = push(ref(db, "pengaturan/marquee_history"));
            await set(newRef, {
              text: marqueeInput.value,
              time: Date.now(),
            });
            statusDiv.textContent = "Tersimpan!";
            setTimeout(() => (statusDiv.textContent = ""), 2000);
          };

          // Render riwayat marquee
          function renderMarqueeHistory(data) {
            const body = document.getElementById("marqueeHistoryBody");
            body.innerHTML = "";
            if (!data) {
              body.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#888;">Belum ada riwayat</td></tr>`;
              return;
            }
            // Urutkan terbaru di atas
            const arr = Object.entries(data).sort(
              (a, b) => b[1].time - a[1].time
            );
            for (const [id, item] of arr) {
              const date = new Date(item.time);
              body.innerHTML += `
              <tr>
                <td style="padding:6px 4px;">${item.text
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;")}</td>
                <td style="padding:6px 4px;font-size:0.98em;color:#388e3c;">${date.toLocaleString(
                  "id-ID"
                )}</td>
                <td style="padding:6px 4px;">
                  <button class="btn" style="padding:4px 10px;font-size:0.95em;" onclick="applyMarquee('${id}')"><i class="bi bi-arrow-repeat"></i> Terapkan</button>
                  <button class="btn btn-reset" style="padding:4px 10px;font-size:0.95em;" onclick="deleteMarquee('${id}')"><i class="bi bi-trash"></i></button>
                </td>
              </tr>
            `;
            }
          }

          // Listen riwayat marquee
          onValue(ref(db, "pengaturan/marquee_history"), (snap) => {
            renderMarqueeHistory(snap.val());
          });

          // Terapkan marquee lama
          window.applyMarquee = async function (id) {
            const snap = await get(ref(db, "pengaturan/marquee_history/" + id));
            if (snap.exists()) {
              marqueeInput.value = snap.val().text;
              await set(ref(db, "pengaturan/marquee"), snap.val().text);
              statusDiv.textContent = "Teks diterapkan!";
              setTimeout(() => (statusDiv.textContent = ""), 2000);
            }
          };

          // Hapus riwayat marquee
          window.deleteMarquee = async function (id) {
            if (confirm("Hapus riwayat ini?")) {
              await remove(ref(db, "pengaturan/marquee_history/" + id));
            }
          };

          // Sidebar Navigation
          document.getElementById("navDashboard").onclick = function () {
            window.location.href = "admin.html";
          };
          document.getElementById("navDisplay").onclick = function () {
            window.location.href = "admin-display.html";
          };
          document.getElementById("navIndex").onclick = function () {
            window.location.href = "admin-index.html";
          };
          document.getElementById("navAkun").onclick = function () {
            window.location.href = "admin-akun.html";
          };
          document.getElementById("navRekap").onclick = function () {
            window.location.href = "rekap.html";
          };

          document.getElementById("btnLogout").onclick = function () {
            localStorage.removeItem("uid");
            localStorage.removeItem("role");
            window.location.href = "login.html";
          };
        </script>
      </main>
    </div>
  </body>
</html>
