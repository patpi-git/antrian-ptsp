<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Rekap Antrian</title>
    <link rel="icon" type="image/png" href="logo.png" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        background: #f1f8f4;
        margin: 0;
      }
      .admin-dashboard {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 250px;
        background: linear-gradient(180deg, #2e7d32 80%, #388e3c 100%);
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        box-shadow: 2px 0 12px #0001;
        z-index: 10;
        min-height: 100vh;
        height: 100vh;
      }
      .sidebar-logo {
        font-size: 1.7rem;
        font-weight: bold;
        padding: 32px 0 24px 0;
        text-align: center;
        letter-spacing: 1px;
        border-bottom: 1px solid #388e3c44;
      }
      .sidebar-nav {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 24px;
        padding: 0 18px;
        flex: 1;
      }
      .nav-btn {
        background: none;
        border: none;
        color: #fff;
        font-size: 1.08rem;
        font-weight: 500;
        text-align: left;
        padding: 12px 18px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 14px;
        transition: background 0.18s, color 0.18s;
      }
      .nav-btn:hover,
      .nav-btn.active {
        background: #e8f5e9;
        color: #2e7d32;
      }
      .main-content {
        margin-left: 250px;
        flex: 1;
        padding: 36px 24px 24px 24px;
        min-width: 0;
      }
      .dashboard-section {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 16px #0001;
        padding: 28px 24px 24px 24px;
        max-width: 1100px;
        margin: 0 auto;
      }
      .dashboard-section h2 {
        margin-bottom: 18px;
        color: #2e7d32;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .rekap-filter {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 18px;
        align-items: center;
        margin-bottom: 18px;
      }
      .rekap-filter label {
        font-weight: 500;
        color: #2e7d32;
      }
      .rekap-filter select,
      .rekap-filter input[type="date"],
      .rekap-filter input[type="month"] {
        padding: 5px 10px;
        border-radius: 6px;
        border: 1px solid #bdbdbd;
        font-size: 1rem;
        background: #f8fffc;
        color: #333;
      }
      .rekap-filter button {
        background: #43a047;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 7px 18px;
        font-size: 1rem;
        cursor: pointer;
        transition: background 0.2s;
        margin-left: 6px;
      }
      .rekap-filter button:hover {
        background: #388e3c;
      }
      .search-bar {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .search-bar input {
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid #bdbdbd;
        font-size: 1rem;
        width: 250px;
        background: #f8fffc;
      }
      .rekap-tabel {
        margin-top: 10px;
        max-height: 60vh;
        overflow: auto;
        font-size: 0.98rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px #0001;
        background: #fafafa;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: #fafafa;
      }
      th,
      td {
        padding: 10px;
        text-align: center;
        font-size: 0.97rem;
        border-bottom: 1px solid #e0e0e0;
      }
      th {
        background-color: #c8e6c9;
        cursor: pointer;
        user-select: none;
        position: sticky;
        top: 0;
        z-index: 1;
      }
      tr:nth-child(even) {
        background-color: #f1f8e9;
      }
      .sort-asc::after {
        content: " ▲";
      }
      .sort-desc::after {
        content: " ▼";
      }
      @media (max-width: 900px) {
        .sidebar {
          width: 60px;
          padding-top: 10px;
        }
        .sidebar .nav-btn {
          padding: 12px 8px;
          font-size: 1.1rem;
          justify-content: center;
        }
        .main-content {
          margin-left: 60px;
          padding: 16px 2vw;
        }
        .dashboard-section {
          padding: 12px 4px;
        }
        th,
        td {
          padding: 6px;
          font-size: 0.92rem;
        }
        .search-bar input {
          width: 100px;
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-dashboard">
      <aside class="sidebar">
        <div class="sidebar-logo">
          <span>Admin Panel</span>
        </div>
        <nav class="sidebar-nav">
          <button class="nav-btn" id="navDashboard">
            <i class="bi bi-speedometer2"></i> Dashboard
          </button>
          <button class="nav-btn" id="navDisplay">
            <i class="bi bi-tv"></i> Kelola Display
          </button>
          <button class="nav-btn" id="navIndex">
            <i class="bi bi-house-door"></i> Kelola Index
          </button>
          <button class="nav-btn" id="navAkun">
            <i class="bi bi-person-gear"></i> Kelola Akun
          </button>
          <button class="nav-btn active" id="navRekap">
            <i class="bi bi-clipboard-data"></i> Rekap Antrian
          </button>
          <button class="nav-btn" id="btnLogout">
            <i class="bi bi-box-arrow-right"></i> Logout
          </button>
        </nav>
      </aside>
      <main class="main-content">
        <section class="dashboard-section">
          <h2><i class="bi bi-clipboard-data"></i> Rekap Antrian</h2>
          <div class="rekap-filter">
            <label>
              Pilih Rekap:
              <select id="rekapTipe">
                <option value="hari">Per Hari</option>
                <option value="minggu">Per Minggu</option>
                <option value="bulan">Per Bulan</option>
              </select>
            </label>
            <input type="date" id="rekapTanggal" style="display: inline" />
            <span id="rekapSampai" style="display: none">s/d</span>
            <input type="date" id="rekapTanggalAkhir" style="display: none" />
            <input type="month" id="rekapBulan" style="display: none" />
            <button id="btnLihatRekap">
              <i class="bi bi-search"></i> Lihat
            </button>
            <button id="btnDownloadRekap">
              <i class="bi bi-download"></i> Download
            </button>
          </div>
          <div class="search-bar" style="display: none" id="searchBar">
            <i class="bi bi-search"></i>
            <input
              type="text"
              id="searchInput"
              placeholder="Cari di tabel..."
            />
          </div>
          <div id="rekapHasil" class="rekap-tabel"></div>
        </section>
      </main>
    </div>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        get,
      } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

      import { db } from "./js/firebase-config.js"; // Ganti path sesuai lokasi file

      // Sidebar Navigation
      document.getElementById("navDashboard").onclick = function () {
        window.location.href = "admin.html";
      };
      document.getElementById("navDisplay").onclick = function () {
        window.location.href = "admin-display.html";
      };
      document.getElementById("navIndex").onclick = function () {
        window.location.href = "admin-index.html";
      };
      document.getElementById("navAkun").onclick = function () {
        window.location.href = "admin-akun.html";
      };
      document.getElementById("navRekap").onclick = function () {
        window.location.href = "rekap.html";
      };
      document.getElementById("btnLogout").onclick = function () {
        localStorage.clear();
        window.location.href = "login.html";
      };

      // Filter logic
      document.getElementById("rekapTipe").onchange = function () {
        const tipe = this.value;
        document.getElementById("rekapTanggal").style.display =
          tipe === "hari" || tipe === "minggu" ? "inline" : "none";
        document.getElementById("rekapTanggalAkhir").style.display =
          tipe === "minggu" ? "inline" : "none";
        document.getElementById("rekapSampai").style.display =
          tipe === "minggu" ? "inline" : "none";
        document.getElementById("rekapBulan").style.display =
          tipe === "bulan" ? "inline" : "none";
      };
      document.getElementById("rekapTipe").dispatchEvent(new Event("change"));

      // Lihat Rekap
      let lastRows = [];
      document.getElementById("btnLihatRekap").onclick = async () => {
        const tipe = document.getElementById("rekapTipe").value;
        let data = {};
        let rows = [];
        if (tipe === "hari") {
          const tanggal = document.getElementById("rekapTanggal").value;
          if (!tanggal) return alert("Pilih tanggal dulu!");
          const snap = await get(ref(db, `logbook/${tanggal}`));
          data = snap.exists() ? snap.val() : {};
          for (let loket in data) {
            for (let nomor in data[loket]) {
              const info = data[loket][nomor];
              rows.push([
                tanggal,
                loket,
                nomor,
                info.waktu ? new Date(info.waktu).toLocaleString("id-ID") : "",
                info.status || "",
                info.keterangan || "",
              ]);
            }
          }
        } else if (tipe === "bulan") {
          const bulan = document.getElementById("rekapBulan").value;
          if (!bulan) return alert("Pilih bulan dulu!");
          const snap = await get(ref(db, `logbook_bulan/${bulan}`));
          data = snap.exists() ? snap.val() : {};
          for (let loket in data) {
            for (let nomor in data[loket]) {
              const info = data[loket][nomor];
              rows.push([
                bulan,
                loket,
                nomor,
                info.waktu ? new Date(info.waktu).toLocaleString("id-ID") : "",
                info.status || "",
                info.keterangan || "",
              ]);
            }
          }
        } else if (tipe === "minggu") {
          const tglAwal = document.getElementById("rekapTanggal").value;
          const tglAkhir = document.getElementById("rekapTanggalAkhir").value;
          if (!tglAwal || !tglAkhir)
            return alert("Pilih tanggal awal dan akhir!");
          let tgl = new Date(tglAwal);
          const tglEnd = new Date(tglAkhir);
          while (tgl <= tglEnd) {
            const tglStr = tgl.toISOString().slice(0, 10);
            const snap = await get(ref(db, `logbook/${tglStr}`));
            if (snap.exists()) {
              const val = snap.val();
              for (let loket in val) {
                for (let nomor in val[loket]) {
                  const info = val[loket][nomor];
                  rows.push([
                    tglStr,
                    loket,
                    nomor,
                    info.waktu
                      ? new Date(info.waktu).toLocaleString("id-ID")
                      : "",
                    info.status || "",
                    info.keterangan || "",
                  ]);
                }
              }
            }
            tgl.setDate(tgl.getDate() + 1);
          }
        }
        lastRows = rows;
        document.getElementById("searchBar").style.display = rows.length
          ? "flex"
          : "none";
        renderTable(rows);
      };

      // Search/filter di tabel
      document
        .getElementById("searchInput")
        .addEventListener("input", function () {
          const keyword = this.value.trim().toLowerCase();
          const filtered = lastRows.filter((row) =>
            row.some((cell) => (cell + "").toLowerCase().includes(keyword))
          );
          renderTable(filtered);
        });

      // Download CSV
      document.getElementById("btnDownloadRekap").onclick = () => {
        const table = document.querySelector("#rekapHasil table");
        if (!table) return alert("Tampilkan rekap dulu!");
        let csv = "";
        for (let row of table.rows) {
          let rowData = [];
          for (let cell of row.cells) {
            rowData.push('"' + cell.innerText.replace(/"/g, '""') + '"');
          }
          csv += rowData.join(",") + "\n";
        }
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.setAttribute("href", url);
        a.setAttribute("download", "rekap_antrian.csv");
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      // Fitur sortir kolom tabel
      let sortCol = -1,
        sortAsc = true;
      function renderTable(rows) {
        let hasil = `
    <div style="display:flex;justify-content:flex-end;align-items:center;margin-bottom:4px;">
      <span style="font-weight:bold;color:#2e7d32;">Total Data: ${
        rows.length
      }</span>
    </div>
    <table id="rekapTable">
      <thead>
        <tr>
          <th data-col="0">Tanggal/Bulan</th>
          <th data-col="1">Loket</th>
          <th data-col="2">Nomor</th>
          <th data-col="3">Waktu</th>
          <th data-col="4">Status</th>
          <th data-col="5">Keterangan</th>
        </tr>
      </thead>
      <tbody>
        ${rows
          .map((r) => `<tr>${r.map((c) => `<td>${c}</td>`).join("")}</tr>`)
          .join("")}
      </tbody>
    </table>
  `;
        document.getElementById("rekapHasil").innerHTML = hasil;
        enableSortTable("rekapTable");
      }

      function enableSortTable(tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;
        table.querySelectorAll("th").forEach((th, idx) => {
          th.onclick = () => {
            if (sortCol === idx) sortAsc = !sortAsc;
            else {
              sortCol = idx;
              sortAsc = true;
            }
            lastRows.sort((a, b) => {
              const va = a[sortCol] + "";
              const vb = b[sortCol] + "";
              return (va > vb ? 1 : va < vb ? -1 : 0) * (sortAsc ? 1 : -1);
            });
            // Jika sedang search, sortir hasil search
            const keyword = document
              .getElementById("searchInput")
              .value.trim()
              .toLowerCase();
            const filtered = keyword
              ? lastRows.filter((row) =>
                  row.some((cell) =>
                    (cell + "").toLowerCase().includes(keyword)
                  )
                )
              : lastRows;
            renderTable(filtered);
            table
              .querySelectorAll("th")
              .forEach((th2) => th2.classList.remove("sort-asc", "sort-desc"));
            th.classList.add(sortAsc ? "sort-asc" : "sort-desc");
          };
        });
      }
    </script>
  </body>
</html>
