<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Display - Marquee</title>
    <link rel="icon" type="image/png" href="logo.png" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        background: #f1f8f4;
      }
      .admin-dashboard {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 250px;
        background: linear-gradient(180deg, #2e7d32 80%, #388e3c 100%);
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        box-shadow: 2px 0 12px #0001;
        z-index: 10;
        min-height: 100vh;
        height: 100vh;
      }
      .sidebar-logo {
        font-size: 1.7rem;
        font-weight: bold;
        padding: 32px 0 24px 0;
        text-align: center;
        letter-spacing: 1px;
        border-bottom: 1px solid #388e3c44;
      }
      .sidebar-nav {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 24px;
        padding: 0 18px;
        flex: 1;
      }
      .nav-btn {
        background: none;
        border: none;
        color: #fff;
        font-size: 1.08rem;
        font-weight: 500;
        text-align: left;
        padding: 12px 18px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 14px;
        transition: background 0.18s, color 0.18s;
      }
      .nav-btn:hover,
      .nav-btn.active {
        background: #e8f5e9;
        color: #2e7d32;
      }
      .main-content {
        margin-left: 250px;
        flex: 1;
        padding: 36px 36px 36px 36px;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 32px;
      }
      .main-header {
        margin-bottom: 18px;
        border-bottom: 1px solid #c8e6c9;
        padding-bottom: 12px;
      }
      .main-header h1 {
        color: #2e7d32;
        font-size: 2rem;
        margin: 0;
        font-weight: 700;
        letter-spacing: 1px;
      }
      .dashboard-section {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 16px #0001;
        padding: 28px 24px 24px 24px;
        margin-bottom: 18px;
        max-width: 700px;
      }
      .dashboard-section h2 {
        color: #388e3c;
        font-size: 1.3rem;
        margin-bottom: 18px;
        font-weight: 600;
      }
      label {
        font-weight: 500;
        color: #388e3c;
        display: block;
        margin-bottom: 6px;
      }
      textarea {
        width: 100%;
        font-size: 1.1rem;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #c8e6c9;
        margin-bottom: 10px;
        resize: vertical;
        background: #f8fffa;
        color: #222;
      }
      .btn {
        background: #43a047;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 18px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.18s;
        margin-right: 6px;
        outline: none;
      }
      .btn:hover,
      .btn:focus {
        background: #388e3c;
      }
      .btn.btn-reset {
        background: #f44336;
      }
      .btn.btn-reset:hover,
      .btn.btn-reset:focus {
        background: #b71c1c;
      }
      .status {
        margin-top: 8px;
        color: #388e3c;
        font-size: 0.98rem;
        min-height: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 18px;
        font-size: 0.98rem;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 4px #0001;
      }
      th,
      td {
        padding: 8px;
        border: 1px solid #c8e6c9;
        text-align: left;
      }
      th {
        background: #c8e6c9;
        color: #2e7d32;
        font-weight: 600;
      }
      .kosong {
        text-align: center;
        color: #888;
        font-style: italic;
      }
      @media (max-width: 900px) {
        .admin-dashboard {
          flex-direction: column;
        }
        .sidebar {
          width: 100vw;
          flex-direction: row;
          height: 60px;
          position: static;
          box-shadow: none;
          border-bottom: 1px solid #388e3c44;
          min-height: unset;
        }
        .sidebar-logo {
          display: none;
        }
        .sidebar-nav {
          flex-direction: row;
          gap: 0;
          margin: 0;
          padding: 0 4px;
          width: 100vw;
          justify-content: space-around;
        }
        .nav-btn {
          flex: 1 1 0;
          padding: 10px 2px;
          font-size: 0.98rem;
          border-radius: 0;
          min-width: 0;
          justify-content: center;
        }
        .main-content {
          padding: 18px 4vw 18px 4vw;
        }
        .dashboard-section {
          padding: 14px 4vw 14px 4vw;
          margin-bottom: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-dashboard">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-logo">
          <span>Admin Panel</span>
        </div>
        <nav class="sidebar-nav">
          <button class="nav-btn" id="navDashboard">
            <i class="bi bi-speedometer2"></i> Dashboard
          </button>
          <button class="nav-btn active" id="navDisplay">
            <i class="bi bi-tv"></i> Kelola Display
          </button>
          <button class="nav-btn" id="navIndex">
            <i class="bi bi-house-door"></i> Kelola Index
          </button>
          <button class="nav-btn" id="navAkun">
            <i class="bi bi-person-gear"></i> Kelola Akun
          </button>
          <button class="nav-btn" id="navRekap">
            <i class="bi bi-clipboard-data"></i> Rekap Antrian
          </button>
          <button class="nav-btn" id="btnLogout">
            <i class="bi bi-box-arrow-right"></i> Logout
          </button>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <header class="main-header">
          <h1>Kelola Marquee Display</h1>
        </header>
        <section class="dashboard-section">
          <h2><i class="bi bi-megaphone"></i> Teks Marquee Display</h2>
          <form id="marqueeForm">
            <label for="marqueeInput">Teks Marquee Saat Ini:</label>
            <textarea
              id="marqueeInput"
              rows="2"
              placeholder="Tulis teks marquee di sini..."
            ></textarea>
            <div style="text-align: right">
              <button type="submit" class="btn">
                <i class="bi bi-save"></i> Simpan
              </button>
              <button type="button" class="btn btn-reset" id="btnClear">
                <i class="bi bi-x-circle"></i> Kosongkan
              </button>
            </div>
            <div class="status" id="marqueeStatus"></div>
          </form>
          <div style="margin-top: 28px">
            <h3 style="color: #388e3c; font-size: 1.1rem">
              Riwayat Marquee Sebelumnya
            </h3>
            <table>
              <thead>
                <tr>
                  <th>Teks</th>
                  <th>Waktu</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody id="marqueeHistoryBody">
                <tr>
                  <td colspan="3" class="kosong">Memuat data...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </main>
    </div>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        remove,
        onValue,
        get,
      } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";
      import {
        getAuth,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";

      // --- Ganti config sesuai project Anda ---
      import { db } from "./js/firebase-config.js"; // Ganti path sesuai lokasi file

      // Sidebar navigation logic
      // Sidebar Navigation
      document.getElementById("navDashboard").onclick = function () {
        window.location.href = "admin.html";
      };
      document.getElementById("navDisplay").onclick = function () {
        window.location.href = "admin-display.html";
      };
      document.getElementById("navIndex").onclick = function () {
        window.location.href = "admin-index.html";
      };
      document.getElementById("navAkun").onclick = function () {
        window.location.href = "admin-akun.html";
      };
      document.getElementById("navRekap").onclick = function () {
        window.location.href = "rekap.html";
      };

      document.getElementById("btnLogout").onclick = function () {
        signOut(auth)
          .then(() => {
            window.location.href = "login.html";
          })
          .catch((error) => {
            alert("Gagal logout: " + error.message);
          });
      };

      // Cek login dan role
      const uid = localStorage.getItem("uid");
      const role = localStorage.getItem("role");
      if (!uid || role !== "utama") {
        window.location.href = "login.html";
      }

      // Marquee logic
      const marqueeInput = document.getElementById("marqueeInput");
      const marqueeForm = document.getElementById("marqueeForm");
      const marqueeStatus = document.getElementById("marqueeStatus");
      const marqueeHistoryBody = document.getElementById("marqueeHistoryBody");
      const btnClear = document.getElementById("btnClear");

      // Ambil marquee aktif
      onValue(ref(db, "display/marquee"), (snap) => {
        marqueeInput.value = snap.val() || "";
      });

      // Simpan marquee baru & tambahkan ke riwayat
      marqueeForm.onsubmit = async (e) => {
        e.preventDefault();
        const text = marqueeInput.value.trim();
        await set(ref(db, "display/marquee"), text);
        if (text) {
          const now = Date.now();
          await set(ref(db, `display/marquee_history/${now}`), {
            text,
            waktu: now,
          });
        }
        marqueeStatus.textContent = "Teks marquee berhasil disimpan!";
        setTimeout(() => (marqueeStatus.textContent = ""), 2000);
      };

      // Kosongkan marquee
      btnClear.onclick = async () => {
        if (confirm("Kosongkan marquee display?")) {
          await set(ref(db, "display/marquee"), "");
          marqueeInput.value = "";
          marqueeStatus.textContent = "Marquee dikosongkan!";
          setTimeout(() => (marqueeStatus.textContent = ""), 2000);
        }
      };

      // Tampilkan riwayat marquee
      function renderMarqueeHistory(data) {
        marqueeHistoryBody.innerHTML = "";
        if (!data) {
          marqueeHistoryBody.innerHTML = `<tr><td colspan="3" class="kosong">Belum ada riwayat marquee.</td></tr>`;
          return;
        }
        // Urutkan terbaru di atas
        const items = Object.entries(data).sort((a, b) => b[0] - a[0]);
        for (const [id, item] of items) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td>${item.text}</td>
          <td>${new Date(item.waktu).toLocaleString("id-ID")}</td>
          <td>
            <button class="btn" title="Terapkan" onclick="window.applyMarquee('${id}')"><i class="bi bi-arrow-repeat"></i></button>
            <button class="btn btn-reset" title="Hapus" onclick="window.deleteMarquee('${id}')"><i class="bi bi-trash"></i></button>
          </td>
        `;
          marqueeHistoryBody.appendChild(tr);
        }
      }

      // Listen riwayat marquee
      onValue(ref(db, "display/marquee_history"), (snap) => {
        renderMarqueeHistory(snap.val());
      });

      // Terapkan marquee lama
      window.applyMarquee = async (id) => {
        const snap = await get(ref(db, `display/marquee_history/${id}`));
        if (snap.exists()) {
          const text = snap.val().text;
          await set(ref(db, "display/marquee"), text);
          marqueeInput.value = text;
          marqueeStatus.textContent = "Teks marquee diterapkan!";
          setTimeout(() => (marqueeStatus.textContent = ""), 2000);
        }
      };

      // Hapus marquee dari riwayat
      window.deleteMarquee = async (id) => {
        if (confirm("Hapus riwayat marquee ini?")) {
          await remove(ref(db, `display/marquee_history/${id}`));
        }
      };
    </script>
  </body>
</html>
